// frontend/js/main.js
document.addEventListener('DOMContentLoaded',()=>{const e=document.getElementById("deal-button"),t=document.getElementById("sort-hand-button"),n=document.getElementById("ai-reference-button"),o=document.getElementById("ai-autoplay-button"),a=document.getElementById("confirm-organization-button"),i=document.getElementById("compare-button"),l=document.getElementById("call-backend-button"),r=document.getElementById("player-hand"),d=document.getElementById("player-top-row"),s=document.getElementById("player-bottom-row"),c=document.getElementById("middle-hand-header"),u=document.getElementById("top-eval-text"),m=document.getElementById("bottom-eval-text"),p=document.getElementById("ai-reference-display"),f=document.getElementById("ai-top-ref"),g=document.getElementById("ai-middle-ref"),h=document.getElementById("ai-bottom-ref"),y="https://wenge.cloudns.ch/backend/";let v=[],E={top:[],middle:[],bottom:[]},H={};const b=10,C=200;letI=0;constN="function"==typeof displayMessage?displayMessage:(e,t)=>t?console.error(e):console.log(e);functionk(){if("undefined"==typeof Sortable){if(I++,I<b)setTimeout(k,C);else{console.error("SortableJS failed!");N("错误：拖拽功能加载失败。",!0)}return}const e={group:"thirteen-water-cards-group",animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onEnd:e=>{S(e.from,e.from.dataset.rowName),e.to!==e.from&&S(e.to,e.to.dataset.rowName),w(),B()},onMove:e=>{const t=e.to,n=parseInt(t.dataset.rowLimit);return!(n&&t!==e.from&&t.children.length>=n)},onAdd:e=>{const t=e.to,n=e.from,o=parseInt(t.dataset.rowLimit);if(o&&t.children.length>o){Sortable.utils.select(e.item).remove();n.appendChild(e.item);N(`${"top"===t.dataset.rowName?"头":"尾"}道已满!`,!0);S(n,n.dataset.rowName);t!==n&&S(t,t.dataset.rowName);w()}}};r&&(sortableInstances.initial_middle=new Sortable(r,{...e,sort:!0}));d&&(sortableInstances.top=new Sortable(d,{...e,sort:!0}));s&&(sortableInstances.bottom=new Sortable(s,{...e,sort:!0}))}function S(e,t){if(!e||!t)return;const n=Array.from(e.children).map(e=>e.cardData).filter(Boolean);"top"===t?E.top=n:"bottom"===t&&(E.bottom=n)}function w(){const e=E.top,t=E.bottom,n=Array.from(r.children).map(e=>e.cardData).filter(Boolean),o=3===e.length&&5===t.length&&5===n.length,a="function"==typeof evaluateHand?evaluateHand:()=>({message:"N/A"});u&&(u.textContent=e.length>0?` (${(3===e.length?a(e).message:"...")||"..."})`:"");m&&(m.textContent=t.length>0?` (${(5===t.length?a(t).message:"...")||"..."})`:"");if(c){const e=document.getElementById("middle-hand-header"),t=document.getElementById("middle-eval-text");e&&t&&(o?(e.childNodes[0].nodeValue="中道 (5张): ",t.textContent=` (${a(n).message||"..."})`,r.classList.add("is-middle-row-style")):(e.childNodes[0].nodeValue="我的手牌 / 中道 (剩余牌): ",t.textContent=n.length>0?` (共${n.length}张)`:"",r.classList.remove("is-middle-row-style")))}}"function"==typeof checkDaoshuiForUI?checkDaoshuiForUI(n):console.warn("checkDaoshuiForUI is not defined")}function T(e){const t=E.top,n=E.bottom;if("function"!=typeof evaluateHand||"function"!=typeof checkDaoshui){N("牌型逻辑缺失。",!0);return}if(3===t.length&&5===n.length&&5===e.length){const o=evaluateHand(t),a=evaluateHand(e),i=evaluateHand(n),l=checkDaoshui(o,a,i);[d,r,s].forEach(e=>e&&(l?e.classList.add("daoshui-warning"):e.classList.remove("daoshui-warning")));l?N("警告: 检测到倒水！",!0):A&&A.disabled&&!B(!0)&&N("请继续理牌...",!1)}else[d,r,s].forEach(e=>e&&e.classList.remove("daoshui-warning"))}function B(e=!1){const t=r.children.length,n=3===E.top.length,o=5===E.bottom.length,i=5===t,l=n&&o&&i;return a&&(a.disabled=!l),l&&!e&&N("牌型已分配，请确认。",!1),l}function L(){v=[],E={top:[],middle:[],bottom:[]};[d,s].forEach(e=>e&&(e.innerHTML=""));r&&(r.innerHTML='<p>点击 "发牌" 开始</p>');[u,m].forEach(e=>e&&(e.textContent=""));const e=document.getElementById("middle-hand-header"),t=document.getElementById("middle-eval-text");e&&t&&(e.childNodes[0].nodeValue="我的手牌 / 中道 (剩余牌): ",t.textContent="");[d,r,s].forEach(e=>e&&e.classList.remove("daoshui-warning","is-middle-row-style"));N("点击“发牌”开始。",!1);"function"==typeof displayScore&&displayScore("");e&&(e.disabled=!1);[t,n,o,a,i].forEach(e=>e&&(e.style.display="none"));a&&(a.disabled=!0);p&&(p.style.display="none");console.log("Game Initialized.")}e.addEventListener("click",(async()=>{console.log("--- Deal Button Clicked ---");L();N("发牌中...",!1);e&&(e.disabled=!0);try{const r=await fetch(`${y}deal_cards.php`);if(!r.ok)throw new Error(`发牌失败: ${r.status} ${await r.text()}`);const d=await r.json();if(!d||!Array.isArray(d.cards)||13!==d.cards.length)throw new Error("牌数据错误。");v=d.cards.map(e=>{const t="undefined"!=typeof SUITS_DATA&&SUITS_DATA[e.suitKey]||{displayChar:"?",cssClass:"unknown",fileNamePart:"unknown"};return{rank:e.rank,suitKey:e.suitKey,displaySuitChar:t.displayChar,suitCssClass:t.cssClass,id:(e.rank||"X")+(e.suitKey||"Y")+Math.random().toString(36).substring(2,7)}}).filter(e=>e.rank&&e.suitKey);let s=null;if("function"==typeof evaluateThirteenCardSpecial)s=evaluateThirteenCardSpecial(v);else console.warn("evaluateThirteenCardSpecial function not found in game.js");if(s){N(`特殊牌型：${s.message}！`,!1);initialAndMiddleHandElement.innerHTML="";const e="function"==typeof sortHandCardsForDisplay?sortHandCardsForDisplay(v):v;e.forEach(e=>initialAndMiddleHandElement.appendChild(renderCard(e,!0)));[t,n,o,a,i].forEach(e=>e&&(e.style.display="none"));dealButton&&(dealButton.disabled=!1)}else{initialAndMiddleHandElement.innerHTML="";v.forEach(e=>{e&&"function"==typeof renderCard?initialAndMiddleHandElement.appendChild(renderCard(e,!0)):console.error("Cannot render card in dealButton:",e)});w();N("请理牌。",!1);[t,n,o,a].forEach(e=>e&&(e.style.display="inline-block"))}}catch(r){console.error("发牌错误:",r);N(`错误: ${r.message}`,!0);e&&(e.disabled=!1)}}));t&&t.addEventListener("click",()=>{console.log("--- Sort Hand Button Clicked ---");if(!r||"function"!=typeof sortHandCardsForDisplay||"function"!=typeof renderCard){N("整理功能出错。",!0);return}let e=Array.from(r.children).map(e=>e.cardData).filter(Boolean);const t=sortHandCardsForDisplay(e);r.innerHTML="";t.forEach(e=>r.appendChild(renderCard(e,!0)));N("手牌已整理。",!1);w()});n&&n.addEventListener("click",()=>{N("AI参考功能建设中...",!0);p&&(p.style.display="block");f&&(f.textContent="AI思考中...");g&&(g.textContent="AI思考中...");h&&(h.textContent="AI思考中...");setTimeout(()=>{f&&(f.textContent="♠A ♠K ♠Q");g&&(g.textContent="♥J ♥10 ♥9 ♥8 ♥7");h&&(h.textContent="♦6 ♦6 ♣6 ♣5 ♣5")},1e3)});o&&o.addEventListener("click",()=>{N("AI托管功能建设中...",!0)});a.addEventListener("click",()=>{console.log("--- Confirm Organization Button Clicked ---");E.middle=Array.from(r.children).map(e=>e.cardData).filter(Boolean);if(3!==E.top.length||5!==E.middle.length||5!==E.bottom.length){N(`牌数错误！头${E.top.length}/3, 中${E.middle.length}/5, 尾${E.bottom.length}/5.`,!0);return}const e="function"==typeof evaluateHand?evaluateHand:()=>({message:"N/A"}),t=e(E.top),n=e(E.middle),o=e(E.bottom),l=document.getElementById("middle-hand-header"),d=document.getElementById("middle-eval-text");l&&d&&(l.childNodes[0].nodeValue="中道 (5张): ",d.textContent=` (${n.message||"未知"})`,r.classList.add("is-middle-row-style"));if("function"==typeof checkDaoshui&&checkDaoshui(t,n,o)){N("警告: 倒水！",!0);[topRowElement,r,s].forEach(e=>e&&e.classList.add("daoshui-warning"))}else{N("理牌完成，可比牌。",!1);[topRowElement,r,s].forEach(e=>e&&e.classList.remove("daoshui-warning"))}[a,sortHandButton,aiReferenceButton,aiAutoplayButton].forEach(e=>e&&(e.style.display="none"));i&&(i.style.display="inline-block",i.disabled=!1)});i.addEventListener("click",(async()=>{console.log("--- Compare Button Clicked ---");N("提交比牌中...",!1);i&&(i.disabled=!0);5!==E.middle.length&&(E.middle=Array.from(r.children).map(e=>e.cardData).filter(Boolean));const e={top:E.top.map(e=>({rank:e.rank,suitKey:e.suitKey})),middle:E.middle.map(e=>({rank:e.rank,suitKey:e.suitKey})),bottom:E.bottom.map(e=>({rank:e.rank,suitKey:e.suitKey}))};if(3!==e.top.length||5!==e.middle.length||5!==e.bottom.length){N("错误:提交牌数不对。",!0);i&&(i.style.display="none");dealButton&&(dealButton.disabled=!1);return}try{const t=await fetch(`${y}submit_hand.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`比牌请求失败: ${t.status} ${await t.text()}`);const n=await t.json();console.log("比牌结果:",n);if(n.success){let e=`服务器: ${n.message||"完成."}`;n.daoshui&&(e+=" (倒水)");N(e,n.daoshui)}else N(`服务器错误: ${n.message||"失败."}`,!0);"function"==typeof displayScore&&"undefined"!=typeof n.score&&displayScore(`得分: ${n.score}`)}catch(e){console.error("比牌错误:",e);N(`错误: ${e.message}`,!0)}finally{dealButton&&(dealButton.disabled=!1);i&&(i.style.display="none")}}));l?l.addEventListener("click",(async()=>{console.log("--- Test Backend Button Clicked! ---");N("正在测试后端通讯...",!1);try{const e=`${y}deal_cards.php`;console.log("Test endpoint URL:",e);const t=await fetch(e);console.log("Test Backend - Fetch response:",t);if(!t.ok){const e=await t.text();throw new Error(`HTTP error! ${t.status} - ${e}`)}const n=await t.json();console.log("Test Backend - Backend response data:",n);let o="后端通讯成功！";(n?.cards?.length>0?o+=` (后端返回 ${n.cards.length} 张牌)`:n?.message&&(o+=` 后端消息: ${n.message}`));N(o,!1)}catch(e){console.error("Test Backend - 通讯捕获到错误:",e);N(`后端通讯测试失败: ${e.message}`,!0)}})):console.error("callBackendButton element NOT found!");L();k()});
