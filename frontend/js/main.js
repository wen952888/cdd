// frontend/js/main.js
document.addEventListener('DOMContentLoaded',()=>{const t=document.getElementById("main-menu-view"),e=document.getElementById("room-view"),n=document.getElementById("game-view"),o=document.getElementById("create-room-btn"),a=document.getElementById("join-room-btn"),i=document.getElementById("room-id-input"),l=document.getElementById("quick-start-btn"),r=document.getElementById("menu-message-area"),s=document.getElementById("room-title"),dd=document.getElementById("current-room-id-display"),pl=document.getElementById("player-list"),d=document.getElementById("start-game-from-room-btn"),c=document.getElementById("leave-room-btn"),u=document.getElementById("room-message-area"),m=document.getElementById("deal-button"),p=document.getElementById("sort-hand-button"),f=document.getElementById("ai-reference-button"),g=document.getElementById("ai-autoplay-button"),h=document.getElementById("confirm-organization-button"),y=document.getElementById("compare-button"),E=document.getElementById("call-backend-button"),H=document.getElementById("back-to-room-btn"),b=document.getElementById("player-hand"),C=document.getElementById("player-top-row"),I=document.getElementById("player-bottom-row"),N=document.getElementById("middle-hand-header"),k=document.getElementById("top-eval-text"),SS=document.getElementById("bottom-eval-text"),w=document.getElementById("ai-reference-display"),TT=document.getElementById("ai-top-ref"),BB=document.getElementById("ai-middle-ref"),LL=document.getElementById("ai-bottom-ref"),grInf=document.getElementById("game-room-info"),guInf=document.getElementById("game-user-info"),authTitle=document.getElementById("auth-title"),loginForm=document.getElementById("login-form"),registerForm=document.getElementById("register-form"),loginUsernameInput=document.getElementById("login-username"),loginPasswordInput=document.getElementById("login-password"),loginBtn=document.getElementById("login-btn"),registerUsernameInput=document.getElementById("register-username"),registerPasswordInput=document.getElementById("register-password"),registerConfirmPasswordInput=document.getElementById("register-confirm-password"),registerBtn=document.getElementById("register-btn"),showRegisterLink=document.getElementById("show-register-link"),showLoginLink=document.getElementById("show-login-link"),gameOptionsDiv=document.getElementById("game-options"),logoutBtn=document.getElementById("logout-btn"),P="https://wenge.cloudns.ch/backend/";let R=[],M={top:[],middle:[],bottom:[]},_cr=null,loggedInUser=null,currentUserTotalScore=0,O={},AA=10,xx=200;letDD=0;letKK=!1,UU=0;constVV=1500,qq="function"==typeof displayMessage?displayMessage:(e,t)=>t?console.error(e):console.log(e),safeDisplayMenuMessage=(e,t=!1)=>{r&&(r.textContent=e,r.style.color=t?"#e74c3c":"#2ecc71")},safeDisplayRoomMessage=(e,t=!1)=>{u&&(u.textContent=e,u.style.color=t?"#e74c3c":"#2ecc71")};functionFF(o){[t,e,n].forEach(t=>t.classList.remove("active-view"));o.classList.add("active-view");_view=o}functionshowAuthForm(t){[loginForm,registerForm].forEach(t=>t.classList.remove("active-auth-form"));gameOptionsDiv&&(gameOptionsDiv.style.display="none");t.classList.add("active-auth-form");authTitle&&(authTitle.textContent=t===loginForm?"用户登录":"用户注册")}functionshowGameOptions(){[loginForm,registerForm].forEach(t=>t.classList.remove("active-auth-form"));gameOptionsDiv&&(gameOptionsDiv.style.display="block");authTitle&&(authTitle.textContent=`欢迎, ${loggedInUser||"玩家"}!`)}functionGG(){let t=document.getElementById("ai-round-selector");if(!t){t=document.createElement("div");t.id="ai-round-selector";t.classList.add("ai-round-selector-popup");let e='<h4>选择AI托管局数：</h4>';[3,5,10].forEach(t=>{e+=`<button class="ai-round-option" data-rounds="${t}">${t} 局</button>`});e+='<button id="cancel-ai-autoplay">取消</button>';t.innerHTML=e;const n=document.querySelector(".controls");n?n.parentNode.insertBefore(t,n.nextSibling):document.body.appendChild(t);t.addEventListener("click",(t=>{"ai-round-option"===t.target.className?(ZZ(parseInt(t.target.dataset.rounds)),jj()):"cancel-ai-autoplay"===t.target.id&&jj()}))}t.style.display="block";[m,p,f,h,y,E,g].forEach(t=>t&&(t.disabled=!0))}function jj(){const t=document.getElementById("ai-round-selector");t&&(t.style.display="none");KK||[m,p,f,E,g].forEach(t=>t&&(t.disabled=!1))}function ZZ(t){t>0&&(KK=!0,UU=t,qq(`AI托管开始，共 ${UU} 局。`,!1),[m,p,f,h,y,E,g].forEach(t=>t&&(t.disabled=!0)),$$())}async function $$(){if(!KK||UU<=0){KK=!1;qq("AI托管结束。",!1);[m,p,f,g,E].forEach(t=>t&&(t.disabled=!1));YY();return}qq(`AI托管：第 ${UU} 局开始...`,!1);m&&(m.disabled=!0);await QQ();if(13===R.length){let t=null;if("function"==typeof evaluateThirteenCardSpecial)t=evaluateThirteenCardSpecial(R);else console.warn("evaluateThirteenCardSpecial not defined");if(t){qq(`AI检测到特殊牌型：${t.message}！`,!1);b.innerHTML="";const e="function"==typeof sortHandCardsForDisplay?sortHandCardsForDisplay(R):R;e.forEach(t=>b.appendChild(renderCard(t,!0)));console.log("AI: Special hand round.")}else{qq("AI正在摆牌...",!1);await new Promise(t=>setTimeout(t,VV/2));const t="function"==typeof getAIRandomValidArrangement?getAIRandomValidArrangement(R):null;t&&t.top&&t.middle&&t.bottom?([C,b,I].forEach(t=>t.innerHTML=""),t.top.forEach(t=>C.appendChild(renderCard(t,!0))),t.middle.forEach(t=>b.appendChild(renderCard(t,!0))),t.bottom.forEach(t=>I.appendChild(renderCard(t,!0))),M={top:t.top,middle:t.middle,bottom:t.bottom},XX(),qq("AI已摆牌并模拟比牌...",!1),await new Promise(t=>setTimeout(t,VV/2)),console.log("AI: Round complete."),"function"==typeof displayScore&&displayScore(`AI局 ${UU} 模拟得分: ${Math.floor(20*Math.random())-10}`)):(qq("AI未能成功摆牌。",!0),console.error("AI Autoplay: getAIRandomValidArrangement failed."))}}else qq("AI托管：发牌失败，中止托管。",!0),KK=!1;UU--;UU>0?(await new Promise(t=>setTimeout(t,VV)),$$()):(KK=!1,qq("AI托管完成。",!1),[m,p,f,g,E].forEach(t=>t&&(t.disabled=!1)),YY())}async function QQ(){try{const t=await fetch(`${P}deal_cards.php`);if(!t.ok)throw new Error("AI Deal: Backend fetch failed");const n=await t.json();if(!n||!Array.isArray(n.cards)||13!==n.cards.length)throw new Error("AI Deal: Invalid card data");R=n.cards.map(t=>{const n="undefined"!=typeof SUITS_DATA&&SUITS_DATA[t.suitKey]||{displayChar:"?",cssClass:"unknown",fileNamePart:"unknown"};return{rank:t.rank,suitKey:t.suitKey,displaySuitChar:n.displayChar,suitCssClass:n.cssClass,id:(t.rank||"X")+(t.suitKey||"Y")+Math.random().toString(36).substring(2,7)}}).filter(t=>t.rank&&t.suitKey);console.log("AI: Cards dealt for AI round.")}catch(t){console.error("AI simulateDealForAI error:",t);R=[];qq(`AI发牌错误: ${t.message}`,!0)}}function z(){if("undefined"==typeof Sortable){if(DD++,DD<AA)setTimeout(z,xx);else{console.error("SortableJS failed!");qq("错误：拖拽功能加载失败。",!0)}return}const t={group:"thirteen-water-cards-group",animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onEnd:t=>{J(t.from,t.from.dataset.rowName),t.to!==t.from&&J(t.to,t.to.dataset.rowName),XX(),WW()},onMove:t=>{const n=t.to,o=parseInt(n.dataset.rowLimit);return!(o&&n!==t.from&&n.children.length>=o)},onAdd:t=>{const n=t.to,o=t.from,a=parseInt(n.dataset.rowLimit);if(a&&n.children.length>a){Sortable.utils.select(t.item).remove();o.appendChild(t.item);qq(`${"top"===n.dataset.rowName?"头":"尾"}道已满!`,!0);J(o,o.dataset.rowName);n!==o&&J(n,n.dataset.rowName);XX()}}};b&&(O.initial_middle=new Sortable(b,{...t,sort:!0}));C&&(O.top=new Sortable(C,{...t,sort:!0}));I&&(O.bottom=new Sortable(I,{...t,sort:!0}))}function J(t,e){if(!t||!e)return;const n=Array.from(t.children).map(t=>t.cardData).filter(Boolean);"top"===e?M.top=n:"bottom"===e&&(M.bottom=n)}function XX(){const t=M.top,e=M.bottom,n=Array.from(b.children).map(t=>t.cardData).filter(Boolean),o=3===t.length&&5===e.length&&5===n.length,a="function"==typeof evaluateHand?evaluateHand:()=>({message:"N/A"});k&&(k.textContent=t.length>0?` (${(3===t.length?a(t).message:"...")||"..."})`:"");SS&&(SS.textContent=e.length>0?` (${(5===e.length?a(e).message:"...")||"..."})`:"");if(N){const t=document.getElementById("middle-hand-header"),e=document.getElementById("middle-eval-text");t&&e&&(o?(t.childNodes[0].nodeValue="中道 (5张): ",e.textContent=` (${a(n).message||"..."})`,b.classList.add("is-middle-row-style")):(t.childNodes[0].nodeValue="我的手牌 / 中道 (剩余牌): ",e.textContent=n.length>0?` (共${n.length}张)`:"",b.classList.remove("is-middle-row-style")))}}"function"==typeof checkDaoshuiForUI?checkDaoshuiForUI(n):console.warn("checkDaoshuiForUI is not defined")}functionKK(t){const e=M.top,n=M.bottom;if("function"!=typeof evaluateHand||"function"!=typeof checkDaoshui){qq("牌型逻辑缺失。",!0);return}if(3===e.length&&5===n.length&&5===t.length){const o=evaluateHand(e),a=evaluateHand(t),i=evaluateHand(n),l=checkDaoshui(o,a,i);[C,b,I].forEach(t=>t&&(l?t.classList.add("daoshui-warning"):t.classList.remove("daoshui-warning")));l?qq("警告: 检测到倒水！",!0):A&&A.disabled&&!WW(!0)&&qq("请继续理牌...",!1)}else[C,b,I].forEach(t=>t&&t.classList.remove("daoshui-warning"))}function WW(t=!1){const e=b.children.length,n=3===M.top.length,o=5===M.bottom.length,a=5===e,i=n&&o&&a;return h&&(h.disabled=!i),i&&!t&&qq("牌型已分配，请确认。",!1),i}function YY(){R=[],M={top:[],middle:[],bottom:[]};[C,I].forEach(t=>t&&(t.innerHTML=""));b&&(b.innerHTML='<p>点击 "发牌" 开始</p>');[k,SS].forEach(t=>t&&(t.textContent=""));const t=document.getElementById("middle-hand-header"),e=document.getElementById("middle-eval-text");t&&e&&(t.childNodes[0].nodeValue="我的手牌 / 中道 (剩余牌): ",e.textContent="");[C,b,I].forEach(t=>t&&t.classList.remove("daoshui-warning","is-middle-row-style"));qq("点击“发牌”开始。",!1);"function"==typeof displayScore&&displayScore("");m&&(m.disabled=!1);[p,f,g,h,y].forEach(t=>t&&(t.style.display="none"));h&&(h.disabled=!0);w&&(w.style.display="none");KK=!1;UU=0;jj();console.log("Game Initialized.")}loginBtn&&loginBtn.addEventListener("click",(async()=>{const t=loginUsernameInput.value.trim(),e=loginPasswordInput.value.trim();if(!t||!e){safeDisplayMenuMessage("手机号和密码不能为空！",!0);return}safeDisplayMenuMessage("正在登录...",!1);try{console.log("Simulating login for phone:",t);loggedInUser=t;currentUserTotalScore=Math.floor(200*Math.random());safeDisplayMenuMessage("登录成功！（模拟）",!1);safeDisplayScore("请开始游戏",currentUserTotalScore);showGameOptions()}catch(t){console.error("Login error:",t);safeDisplayMenuMessage(`登录时发生错误: ${t.message}`,!0)}}));registerBtn&®isterBtn.addEventListener("click",(async()=>{const t=registerUsernameInput.value.trim(),e=registerPasswordInput.value.trim(),n=registerConfirmPasswordInput.value.trim();if(!t||!e||!n){safeDisplayMenuMessage("所有注册字段均不能为空！",!0);return}if(!/^\d+$/.test(t)||t.length<7||t.length>15);if(e!==n){safeDisplayMenuMessage("两次输入的密码不匹配！",!0);return}if(e.length<6){safeDisplayMenuMessage("密码长度至少为6位！",!0);return}safeDisplayMenuMessage("正在提交注册信息...",!1);try{const o=await fetch(`${P}register_user.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:t,password:e})}),a=await o.json();o.ok&&a.success?(loggedInUser=t,currentUserTotalScore=0,safeDisplayMenuMessage(a.message||"注册成功，已自动登录！",!1),safeDisplayScore("请开始游戏",currentUserTotalScore),showGameOptions()):safeDisplayMenuMessage(a.message||"注册失败，请稍后再试或联系管理员。",!0)}catch(t){console.error("Registration fetch error:",t);safeDisplayMenuMessage("注册过程中发生网络错误，请检查您的连接。",!0)}}));showRegisterLink&&showRegisterLink.addEventListener("click",(t=>{t.preventDefault();showAuthForm(registerForm);safeDisplayMenuMessage("")}));showLoginLink&&showLoginLink.addEventListener("click",(t=>{t.preventDefault();showAuthForm(loginForm);safeDisplayMenuMessage("")}));logoutBtn&&logoutBtn.addEventListener("click",(()=>{loggedInUser=null;currentUserTotalScore=0;safeDisplayMenuMessage("已退出登录。",!1);showAuthForm(loginForm)}));o&&o.addEventListener("click",(()=>{_cr="room_"+Math.random().toString(16).slice(2,10);s&&(s.textContent=`房间: ${_cr}`);dd&&(dd.textContent=_cr);pl&&(pl.innerHTML=`<li>${loggedInUser||"您"} (房主)</li>`);safeDisplayRoomMessage("房间已创建！等待其他玩家或开始游戏。",!1);FF(e)}));a&&a.addEventListener("click",(()=>{const t=i?i.value.trim():"";t?(_cr=t,s&&(s.textContent=`房间: ${_cr}`),dd&&(dd.textContent=_cr),pl&&(pl.innerHTML=`<li>${loggedInUser||"您"}</li>`),safeDisplayRoomMessage(`已加入房间 ${t}`,!1),FF(e),i.value=""):safeDisplayMenuMessage("请输入房间ID！",!0)}));l&&l.addEventListener("click",(()=>{_cr="solo_"+Date.now();s&&(s.textContent="单人游戏");dd&&(dd.textContent="单人模式");pl&&(pl.innerHTML=`<li>${loggedInUser||"您"}</li>`);safeDisplayRoomMessage("准备开始单人游戏。",!1);FF(e);setTimeout(()=>{d&&d.click()},100)}));d&&d.addEventListener("click",(()=>{if(u)u.textContent="";FF(n);grInf&&(grInf.textContent=`房间: ${_cr||"N/A"}`);guInf&&(guInf.textContent=`玩家: ${loggedInUser||"访客"}`);if("function"==typeof initializeGame)initializeGame();else console.error("initializeGame function is not defined for starting game!");m&&setTimeout(()=>m.click(),100)}));c&&c.addEventListener("click",(()=>{u&&(u.textContent="");_cr=null;FF(t);loggedInUser?showGameOptions():showAuthForm(loginForm)}));m&&m.addEventListener("click",(async()=>{console.log("--- Deal Button Clicked ---");YY();qq("发牌中...",!1);m&&(m.disabled=!0);try{const t=await fetch(`${P}deal_cards.php`);if(!t.ok)throw new Error(`发牌失败: ${t.status} ${await t.text()}`);const e=await t.json();if(!e||!Array.isArray(e.cards)||13!==e.cards.length)throw new Error("牌数据错误。");R=e.cards.map(t=>{const e="undefined"!=typeof SUITS_DATA&&SUITS_DATA[t.suitKey]||{displayChar:"?",cssClass:"unknown",fileNamePart:"unknown"};return{rank:t.rank,suitKey:t.suitKey,displaySuitChar:e.displayChar,suitCssClass:e.cssClass,id:(t.rank||"X")+(t.suitKey||"Y")+Math.random().toString(36).substring(2,7)}}).filter(t=>t.rank&&t.suitKey);let n=null;if("function"==typeof evaluateThirteenCardSpecial)n=evaluateThirteenCardSpecial(R);else console.warn("evaluateThirteenCardSpecial function not found in game.js");if(n){qq(`特殊牌型：${n.message}！`,!1);b.innerHTML="";const t="function"==typeof sortHandCardsForDisplay?sortHandCardsForDisplay(R):R;t.forEach(t=>b.appendChild(renderCard(t,!0)));[p,f,g,h,y].forEach(t=>t&&(t.style.display="none"));m&&(m.disabled=!1)}else{b.innerHTML="";R.forEach(t=>{t&&"function"==typeof renderCard?b.appendChild(renderCard(t,!0)):console.error("Cannot render card in dealButton:",t)});XX();qq("请理牌。",!1);[p,f,g,h].forEach(t=>t&&(t.style.display="inline-block"))}}catch(t){console.error("发牌错误:",t);qq(`错误: ${t.message}`,!0);m&&(m.disabled=!1)}}));p&&p.addEventListener("click",()=>{console.log("--- Sort Hand Button Clicked ---");if(!b||"function"!=typeof sortHandCardsForDisplay||"function"!=typeof renderCard){qq("整理功能出错。",!0);return}let t=Array.from(b.children).map(t=>t.cardData).filter(Boolean);const e=sortHandCardsForDisplay(t);b.innerHTML="";e.forEach(t=>b.appendChild(renderCard(t,!0)));qq("手牌已整理。",!1);XX()});f&&f.addEventListener("click",()=>{qq("AI参考功能建设中...",!0);w&&(w.style.display="block");T&&(T.textContent="AI思考中...");B&&(B.textContent="AI思考中...");LL&&(LL.textContent="AI思考中...");setTimeout(()=>{T&&(T.textContent="♠A ♠K ♠Q");B&&(B.textContent="♥J ♥10 ♥9 ♥8 ♥7");LL&&(LL.textContent="♦6 ♦6 ♣6 ♣5 ♣5")},1e3)});g&&g.addEventListener("click",(()=>{KK?KK=!1:GG()}));h&&h.addEventListener("click",()=>{console.log("--- Confirm Organization Button Clicked ---");M.middle=Array.from(b.children).map(t=>t.cardData).filter(Boolean);if(3!==M.top.length||5!==M.middle.length||5!==M.bottom.length){qq(`牌数错误！头${M.top.length}/3, 中${M.middle.length}/5, 尾${M.bottom.length}/5.`,!0);return}const t="function"==typeof evaluateHand?evaluateHand:()=>({message:"N/A"}),n=t(M.top),o=t(M.middle),a=t(M.bottom),i=document.getElementById("middle-hand-header"),l=document.getElementById("middle-eval-text");i&&l&&(i.childNodes[0].nodeValue="中道 (5张): ",l.textContent=` (${o.message||"未知"})`,b.classList.add("is-middle-row-style"));if("function"==typeof checkDaoshui&&checkDaoshui(n,o,a)){qq("警告: 倒水！",!0);[C,b,I].forEach(t=>t&&t.classList.add("daoshui-warning"))}else{qq("理牌完成，可比牌。",!1);[C,b,I].forEach(t=>t&&t.classList.remove("daoshui-warning"))}[h,p,f,g].forEach(t=>t&&(t.style.display="none"));y&&(y.style.display="inline-block",y.disabled=!1)});y&&y.addEventListener("click",(async()=>{console.log("--- Compare Button Clicked ---");qq("提交比牌中...",!1);y&&(y.disabled=!0);5!==M.middle.length&&(M.middle=Array.from(b.children).map(t=>t.cardData).filter(Boolean));const t={top:M.top.map(t=>({rank:t.rank,suitKey:t.suitKey})),middle:M.middle.map(t=>({rank:t.rank,suitKey:t.suitKey})),bottom:M.bottom.map(t=>({rank:t.rank,suitKey:t.suitKey})),currentUserPhone:loggedInUser};if(3!==t.top.length||5!==t.middle.length||5!==t.bottom.length){qq("错误:提交牌数不对。",!0);y&&(y.style.display="none");m&&(m.disabled=!1);return}try{const n=await fetch(`${P}submit_hand.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`比牌请求失败: ${n.status} ${await n.text()}`);const o=await n.json();console.log("比牌结果:",o);if(o.success){let t=`服务器: ${o.message||"完成."}`;o.daoshui&&(t+=" (倒水)");qq(t,o.daoshui);"undefined"!=typeof o.new_total_score&&(currentUserTotalScore=o.new_total_score);let a=`本局输赢: ${(o.score_change>0?"+":"")+o.score_change}`;safeDisplayScore(a,currentUserTotalScore)}else qq(`服务器错误: ${o.message||"失败."}`,!0);"function"==typeof displayScore&&"undefined"!=typeof o.score&&"undefined"==typeof o.new_total_score&&displayScore(`得分: ${o.score}`)}catch(t){console.error("比牌错误:",t);qq(`错误: ${t.message}`,!0)}finally{m&&(m.disabled=!1);y&&(y.style.display="none")}}));E?E.addEventListener("click",(async()=>{console.log("--- Test Backend Button Clicked! ---");qq("正在测试后端通讯...",!1);try{const t=`${P}deal_cards.php`;console.log("Test endpoint URL:",t);const e=await fetch(t);console.log("Test Backend - Fetch response:",e);if(!e.ok){const t=await e.text();throw new Error(`HTTP error! ${e.status} - ${t}`)}const n=await e.json();console.log("Test Backend - Backend response data:",n);let o="后端通讯成功！";(n?.cards?.length>0?o+=` (后端返回 ${n.cards.length} 张牌)`:n?.message&&(o+=` 后端消息: ${n.message}`));qq(o,!1)}catch(t){console.error("Test Backend - 通讯捕获到错误:",t);qq(`后端通讯测试失败: ${t.message}`,!0)}})):console.error("callBackendButton element NOT found!");H&&H.addEventListener("click",(()=>{KK&&(KK=!1,UU=0,qq("AI托管已中止。",!1));YY();FF(e);loggedInUser?showGameOptions():showAuthForm(loginForm)}));FF(t);z()});
